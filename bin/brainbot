#!/usr/bin/env node

var IRC   = require('hook.io-irc').IRC;
var CouchDB = require('hook.io-couch').CouchHook;
var Hook = require('hook.io').Hook;
var LinkManager = require('../lib/link-manager');
var CouchManager = require('../lib/couch-manager');
var ConfigManager = require('../lib/config-manager');

var master = new Hook({ name: 'brainbot-master' });
var config = new ConfigManager().get();
var couchManager = new CouchManager(config.couch.db, config.couch.port, config.host);

master.on('hook::ready', function() {
  master.spawn([config.irc, config.couch]);

});

master.on('children::ready', function() {
  master.on('*::*::msg', function(data) {
    var links = LinkManager.getContext(data);
    links.forEach(function(link) {
      master.emit("master::newLink", link);
      couchManager.add(link);
    });
  });
});

  
master.start();
